---
name: Lint and Test Charts
"on":
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main

env:
  python_version: '3.10'

jobs:
  prep_job:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: tj-actions/changed-files@v40
        id: changed-files
        with:
          files: |
            **/*.yaml
            **/*.yml
            **/*.tpl
          files_ignore: |
            **/*.md
            .github/**

  test:
    runs-on: ubuntu-latest
    needs: prep_job
    if: ${{ needs.prep_job.outputs.has_changes == 'true' }}
    env:
      # see https://github.com/kubernetes-sigs/kind/releases
      # make sure to update the image refs in the matrix as well, when update this version!
      kind_version: v0.20.0
    strategy:
      matrix:
        include:
          - name: k8s-1.27
            kindest_image: kindest/node:v1.27.3@sha256:3966ac761ae0136263ffdb6cfd4db23ef8a83cba8a463690e98317add2c9ba72
          - name: k8s-1.26
            kindest_image: kindest/node:v1.26.6@sha256:6e2d8b28a5b601defe327b98bd1c2d1930b49e5d8c512e1895099e4504007adb
          - name: k8s-1.25
            kindest_image: kindest/node:v1.25.11@sha256:227fa11ce74ea76a0474eeefb84cb75d8dad1b08638371ecf0e86259b35be0c8
          - name: k8s-1.24
            kindest_image: kindest/node:v1.24.15@sha256:7db4f8bea3e14b82d12e044e25e34bd53754b7f2b0e9d56df21774e6f66a70ab
          - name: k8s-1.23
            kindest_image: kindest/node:v1.23.17@sha256:59c989ff8a517a93127d4a536e7014d28e235fb3529d9fba91b3951d461edfdb
    name: ${{ matrix.name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: azure/setup-helm@v3.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.python_version }}

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.0

      - name: Lint charts
        run: ct lint --config .github/workflows/conf/ct-lint.yml

      - uses: helm/kind-action@main
        with:
          config: .github/workflows/conf/kind.yml
          version: ${{ env.kind_version }}
          node_image: ${{ matrix.kindest_image }}

      - name: Create chart preconditions
        run: .github/workflows/scripts/chart-test-prep.sh

      - name: Chart installation tests
        run: .github/workflows/scripts/chart-test.sh

      - name: Debug information on failure
        run: kubectl describe nodes; echo "=== API Versions ==="; kubectl api-versions; echo "=== CRDs ==="; kubectl get crd
        if: failure()

  lint:
    runs-on: ubuntu-latest
    needs: prep_job
    if: ${{ needs.prep_job.outputs.has_changes == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.python_version }}

      - name: Run checkov on each test case permutation
        run: .github/workflows/scripts/checkov-chart-linting.sh

  skip:
    runs-on: ubuntu-latest
    needs: prep_job
    if: ${{ needs.prep_job.outputs.has_changes != 'true' }}
    strategy:
      matrix:
        include:
          - name: k8s-1.27
          - name: k8s-1.26
          - name: k8s-1.25
          - name: k8s-1.24
          - name: k8s-1.23
          - name: lint
    name: ${{ matrix.name }}
    steps:
      - run: |
          echo "Skip ${{ matrix.name }} for this pull request because no relevant files have been changed."
          echo "This is needed to not block the pull request as these are configured as required status check."
