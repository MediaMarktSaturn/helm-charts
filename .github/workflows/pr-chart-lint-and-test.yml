---
name: Lint and Test Charts
# yamllint disable-line rule:truthy
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main
env:
  # see https://github.com/kubernetes-sigs/kind/releases
  kind_version: v0.18.0
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # take the images for a certain kind version from its GH release page: https://github.com/kubernetes-sigs/kind/releases
          - name: k8s-1.26
            kindest_image: kindest/node:v1.26.3@sha256:61b92f38dff6ccc29969e7aa154d34e38b89443af1a2c14e6cfbd2df6419c66f
          - name: k8s-1.25
            kindest_image: kindest/node:v1.25.8@sha256:00d3f5314cc35327706776e95b2f8e504198ce59ac545d0200a89e69fce10b7f
          - name: k8s-1.24
            kindest_image: kindest/node:v1.24.12@sha256:1e12918b8bc3d4253bc08f640a231bb0d3b2c5a9b28aa3f2ca1aee93e1e8db16
          - name: k8s-1.23
            kindest_image: kindest/node:v1.23.17@sha256:e5fd1d9cd7a9a50939f9c005684df5a6d145e8d695e78463637b79464292e66c
          - name: k8s-1.22
            kindest_image: kindest/node:v1.22.17@sha256:c8a828709a53c25cbdc0790c8afe12f25538617c7be879083248981945c38693
          - name: k8s-1.21
            kindest_image: kindest/node:v1.21.14@sha256:27ef72ea623ee879a25fe6f9982690a3e370c68286f4356bf643467c552a3888
    name: ${{ matrix.name }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: azure/setup-helm@v3.5

      - uses: actions/setup-python@v4

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.4.0

      - name: Lint charts
        run: ct lint --config .github/workflows/conf/ct.yml

      - uses: helm/kind-action@main
        with:
          config: .github/workflows/conf/kind.yml
          version: ${{ env.kind_version }}
          node_image: ${{ matrix.kindest_image }}

      - name: Create chart preconditions
        run: .github/workflows/scripts/chart-test-prep.sh

      - name: Chart installation tests
        run: .github/workflows/scripts/chart-test.sh

      - name: Debug information on failure
        run: kubectl describe nodes; echo "=== API Versions ==="; kubectl api-versions; echo "=== CRDs ==="; kubectl get crd
        if: failure()

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v4

      - name: Run checkov on each test case permutation
        run: .github/workflows/scripts/checkov-chart-linting.sh
